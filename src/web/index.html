<html>
<style>
#app {
  box-sizing: border-box;
}

#left {
  float: left;
  width: 50%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

#right {
  float: left;
  width: 50%;
  height: 100%;
}

#monitorgame {
    width: 50%;
    height: 50%;
}

#board {
    width: 100%;
    height: 100%;
}

table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

thead tr, tr:nth-child(even) {
  background-color: #dddddd;
}

.row {
  width: 100%;
  display: flex;
  height: 9%;
}

.square {
  border: 1px solid grey;
  width: 9%;
  background: #eee;
}

.base {
  background: red;
}

.white {
  background: white;
  width: 80%;
  height: 80%;
  margin: auto;
  margin-top: 10%;
  border-radius: 50%;
  border: 1px solid black;
}

.black {
  background: black;
  width: 80%;
  height: 80%;
  margin: auto;
  margin-top: 10%;
  border-radius: 50%;
}

.king {
  background: white;
  width: 80%;
  height: 80%;
  margin: auto;
  margin-top: 10%;
  border-radius: 50%;
  border: 1px solid black;
  vertical-align: center;
  text-align: center;
  line-height: 1.5em;
}

.movable {
  background: green;
}

.clickable {
  cursor: pointer;
}
</style>

<div id="app">
    <div id="left">
        <div id="monitorgame">
            <div id="board">

            </div>
            <div>
            <select name="variant" id="variant" onchange="updatevariant()">
              <option value="oldhnefatafl">Old Hnefatafl</option>
              <option value="legacyhnefatafl">Legacy Hnefatafl</option>
              <option value="copenhagenhnefatafl">Copenhagen Hnefatafl</option>
              <option value="historicalhnefatafl">Historical Hnefatafl</option>
              <option value="federationbrandubh">Federation Brandubh</option>
              <option value="historicaltablut">Historical Tablut</option>
            </select>
            /Play/Pause/Restart</div>
        </div>
    </div>

    <div id="right">
        <table>
          <thead>
            <tr>
                <th>Moves</th>
                <th>Count</th>
                <th>Victories (white)</th>
                <th>Victories (black)</th>
            </tr>
          </thead>
          <tbody id="moves">
          </tbody>
        </table>
    </div>
</div>

<script>
var board = document.getElementById("board");
var movesArray = document.getElementById("moves");
var variantCombobox = document.getElementById("variant");

const old_hnefatafl = [
  'B', ' ', ' ', 'P', 'P', 'P',  'P', 'P', ' ', ' ', 'B',
  ' ', ' ', ' ', ' ', ' ', 'P',  ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', ' ',  ' ', ' ', ' ', ' ', ' ',
  'P', ' ', ' ', ' ', ' ', 'W',  ' ', ' ', ' ', ' ', 'P',
  'P', ' ', ' ', ' ', 'W', 'W',  'W', ' ', ' ', ' ', 'P',
  'P', 'P', ' ', 'W', 'W', 'KB', 'W', 'W', ' ', 'P', 'P',
  'P', ' ', ' ', ' ', 'W', 'W',  'W', ' ', ' ', ' ', 'P',
  'P', ' ', ' ', ' ', ' ', 'W',  ' ', ' ', ' ', ' ', 'P',
  ' ', ' ', ' ', ' ', ' ', ' ',  ' ', ' ', ' ', ' ', ' ',
  ' ', ' ', ' ', ' ', ' ', 'P',  ' ', ' ', ' ', ' ', ' ',
  'B', ' ', ' ', 'P', 'P', 'P',  'P', 'P', ' ', ' ', 'B'
]
const legacy_hnefatafl = old_hnefatafl;
const copenhagen_hnefatafl = old_hnefatafl;
const historical_hnefatafl = [
  'B',  'B', 'B', 'B', 'BP', 'BP', 'BP', 'B', 'B', 'B', 'B ',
  'B',  ' ', ' ', ' ', 'P',  ' ',  'P',  ' ', ' ', ' ', 'B ',
  'B',  ' ', ' ', ' ', ' ',  'P',  ' ',  ' ', ' ', ' ', 'B ',
  'B',  ' ', ' ', ' ', ' ',  'W',  ' ',  ' ', ' ', ' ', 'B ',
  'BP', 'P', ' ', ' ', 'W',  'W',  'W',  ' ', ' ', 'P', 'BP',
  'BP', ' ', 'P', 'W', 'W',  'K',  'W',  'W', 'P', ' ', 'BP',
  'BP', 'P', ' ', ' ', 'W',  'W',  'W',  ' ', ' ', 'P', 'BP',
  'B',  ' ', ' ', ' ', ' ',  'W',  ' ',  ' ', ' ', ' ', 'B ',
  'B',  ' ', ' ', ' ', ' ',  'P',  ' ',  ' ', ' ', ' ', 'B ',
  'B',  ' ', ' ', ' ', 'P',  ' ',  'P',  ' ', ' ', ' ', 'B ',
  'B',  'B', 'B', 'B', 'BP', 'BP', 'BP', 'B', 'B', 'B', 'B'
]
const federation_brandubh = [
  'B', ' ', ' ', 'P',  ' ', ' ', 'B',
  ' ', ' ', ' ', 'P',  ' ', ' ', ' ',
  ' ', ' ', ' ', 'W',  ' ', ' ', ' ',
  'P', 'P', 'W', 'BK', 'W', 'P', 'P',
  ' ', ' ', ' ', 'W',  ' ', ' ', ' ',
  ' ', ' ', ' ', 'P',  ' ', ' ', ' ',
  'B', ' ', ' ', 'P',  ' ', ' ', 'B'
]
const historical_tablut = [
  'B',  'B', 'B', 'BP', 'BP', 'BP', 'B', 'B', 'B ',
  'B',  ' ', ' ', ' ',  'P',  ' ',  ' ', ' ', 'B ',
  'B',  ' ', ' ', ' ',  'W',  ' ',  ' ', ' ', 'B ',
  'BP', ' ', ' ', ' ',  'W',  ' ',  ' ', ' ', 'BP',
  'BP', 'P', 'W', 'W',  'BK', 'W',  'W', 'P', 'BP',
  'BP', ' ', ' ', ' ',  'W',  ' ',  ' ', ' ', 'BP',
  'B',  ' ', ' ', ' ',  'W',  ' ',  ' ', ' ', 'B ',
  'B',  ' ', ' ', ' ',  'P',  ' ',  ' ', ' ', 'B ',
  'B',  'B', 'B', 'BP', 'BP', 'BP', 'B', 'B', 'B'
]

var current_search = "";
var variant = 'oldhnefatafl';
const variants = {'oldhnefatafl': old_hnefatafl, 'legacyhnefatafl': legacy_hnefatafl, 'copenhagenhnefatafl': copenhagen_hnefatafl, 'historicalhnefatafl': historical_hnefatafl, 'federationbrandubh': federation_brandubh, 'historicaltablut': historical_tablut};
var currentMove = null;

function startMove(pos) {
  var boardFromVariant = variants[variant];
  var size = Math.sqrt(boardFromVariant.length)
  var startx = pos[0]
  var starty = pos[1]

  var square = document.getElementById(`square_${startx}_${starty}`)
  var isMovable = square.classList.contains('movable');
  var movables = document.querySelectorAll(".movable");
  [].forEach.call(movables, function (el) {
    el.className = el.className.replace(/ movable/, "");
  });
  if (isMovable && currentMove !== null) {
    // End of the move
    // TODO add action
    // TODO capture
    // Search
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    var start = currentMove
    var end = pos
    var action = `${alphabet[start[0]]}${size - start[1]}-${alphabet[end[0]]}${size - end[1]}`
    console.log(action)
    execute_action(action)
    currentMove = null
    if (current_search !== '') {
      current_search += "\\n"
    }
    current_search += action
    searchMoves();
    return;
  } else if (square.innerHTML === '') {
    return;
  } else if (pos === currentMove) {
    currentMove = null
    return; // Abort current move
  } else {
    currentMove = pos;
  }

  for (var x = startx + 1; x < size; ++x) {
    var square = document.getElementById(`square_${x}_${starty}`)
    if (square.innerHTML === '') {
      square.className += ' movable'
    } else {
      break;
    }
  }
  for (var x = startx - 1; x >= 0; --x) {
    var square = document.getElementById(`square_${x}_${starty}`)
    if (square.innerHTML === '') {
      square.className += ' movable'
    } else {
      break;
    }
  }
  for (var y = starty + 1; y < size; ++y) {
    var square = document.getElementById(`square_${startx}_${y}`)
    if (square.innerHTML === '') {
      square.className += ' movable'
    } else {
      break;
    }
  }
  for (var y = starty - 1; y >= 0; --y) {
    var square = document.getElementById(`square_${startx}_${y}`)
    if (square.innerHTML === '') {
      square.className += ' movable'
    } else {
      break;
    }
  }
}

function fillBoard() {
  var boardFromVariant = variants[variant];
  board.innerHTML = ''
  var size = Math.sqrt(boardFromVariant.length)
  for (var y = 0; y < size; ++y) {
    var row = document.createElement("div");
    row.className = "row";
    for (var x = 0; x < size; ++x) {
      var model = boardFromVariant[y*size+x]
      var square = document.createElement("div");
      square.pos = [x, y]
      square.addEventListener("click", function () {
        startMove(this.pos)
      });
      var bonus = ''
      if (model.indexOf('B') != -1) {
        bonus += 'base';
      }
      square.id = `square_${x}_${y}`;
      square.className = `square ${bonus}`;
      if (model.indexOf('W') != -1) {
        var white = document.createElement("div");
        white.className = "white";
        square.appendChild(white);
      } else if (model.indexOf('P') != -1) {
        var black = document.createElement("div");
        black.className = "black";
        square.appendChild(black);
      } else if (model.indexOf('K') != -1) {
        var king = document.createElement("div");
        king.className = "king";
        king.innerText = "ðŸ‘‘";
        square.appendChild(king);
      }
      row.appendChild(square);
    }
    board.appendChild(row);
  }
}

function get_square(square) {
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const boardFromVariant = variants[variant];
  const size = Math.sqrt(boardFromVariant.length)
  return [alphabet.indexOf(square[0]), size - parseInt(square.substring(1))]
}

function execute_action(action) {
  const regex = /(?<from>[A-Z]+[0-9]+)-(?<dest>[A-Z]+[0-9]+)x?(?<take>[A-Z0-9/]*)(\+\+)?$/
  const found = action.match(regex)
  // Do move
  var sq = get_square(found.groups.from)
  var squareFrom = document.getElementById(`square_${sq[0]}_${sq[1]}`)
  var sq = get_square(found.groups.dest)
  var squareDest = document.getElementById(`square_${sq[0]}_${sq[1]}`)
  squareDest.innerHTML = squareFrom.innerHTML
  squareFrom.innerHTML = ''
  // Do takes
  if (found.groups.take !== '') {
    const takes = found.groups.take.split('/')
    for (take of takes) {
      var sq = get_square(take)
      var square = document.getElementById(`square_${sq[0]}_${sq[1]}`)
      square.innerHTML = ''
    }
  }
}

async function searchMoves() {
  movesArray.innerText = ''
  var moves = await fetch(`http://127.0.0.1:1412/search/${variant}`, { method: 'POST', body: `{"moves": "${current_search}"}` })
                      .then(response => response.json());

  for (move of moves) {
    var row = document.createElement('tr')
    var id = document.createElement('td')
    id.innerText = move['id']
    id.className = 'clickable'
    id.addEventListener("click", function () {
        //if (this.innerText.indexOf('++') != -1) {
        //  return
        //}
        execute_action(this.innerText)

        if (current_search !== '') {
          current_search += "\\n"
        }
        current_search += this.innerText
        searchMoves();
      });
    row.appendChild(id)
    var count = document.createElement('td')
    count.innerText = move['count']
    row.appendChild(count)
    var whiteWin = document.createElement('td')
    whiteWin.innerText = move['whiteWin'] * 100
    whiteWin.innerText += "%"
    row.appendChild(whiteWin)
    var blackWin = document.createElement('td')
    blackWin.innerText = move['blackWin'] * 100
    blackWin.innerText += "%"
    row.appendChild(blackWin)
    movesArray.appendChild(row)
  }
}

function updatevariant() {
  variant = variantCombobox.value
  current_search = ''
  fillBoard();
  searchMoves();
}

fillBoard();
searchMoves();

</script>
</html>